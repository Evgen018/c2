<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Простой калькулятор</title>
    <style>
      * {
        box-sizing: border-box;
        font-family: Arial, sans-serif;
      }

      :root {
        --bg: #f5f5f5;
        --card-bg: #ffffff;
        --text: #111111;
        --display-bg: #fafafa;
        --display-border: #d9d9d9;
        --shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        --btn-bg: #e7e7e7;
        --btn-text: #111111;
        --btn-operator: #ffe6cc;
        --btn-control: #ffd6d6;
        --btn-clear: #ff6b6b;
        --btn-clear-text: #ffffff;
        --btn-equals: #b7f5a1;
        --btn-toggle: #ededed;
      }

      body.dark {
        --bg: #0f1115;
        --card-bg: #181b22;
        --text: #f5f7fb;
        --display-bg: #0f1319;
        --display-border: #2a2f3a;
        --shadow: 0 10px 25px rgba(0, 0, 0, 0.6);
        --btn-bg: #242a35;
        --btn-text: #f5f7fb;
        --btn-operator: #574125;
        --btn-control: #4a2c35;
        --btn-clear: #d64545;
        --btn-clear-text: #ffffff;
        --btn-equals: #3d7a46;
        --btn-toggle: #222937;
      }

      body {
        margin: 0;
        padding: 24px;
        background: var(--bg);
        color: var(--text);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        transition: background 0.2s ease, color 0.2s ease;
      }

      .layout {
        display: flex;
        gap: 16px;
        align-items: flex-start;
        justify-content: center;
        width: min(720px, 100%);
      }

      .calculator {
        width: 320px;
        background: var(--card-bg);
        color: var(--text);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 24px;
        transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
      }

      .calculator-header {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 12px;
      }

      .theme-toggle {
        border: none;
        border-radius: 10px;
        padding: 8px 12px;
        background: var(--btn-toggle);
        color: var(--text);
        cursor: pointer;
        font-size: 14px;
        transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.2s ease;
      }

      .theme-toggle:active {
        transform: translateY(1px);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .display {
        width: 100%;
        height: 64px;
        margin-bottom: 16px;
        padding: 12px;
        border: 2px solid var(--display-border);
        border-radius: 12px;
        text-align: right;
        font-size: 28px;
        background: var(--display-bg);
        color: var(--text);
        overflow: hidden;
        transition: background 0.2s ease, border-color 0.2s ease, color 0.2s ease;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
      }

      button {
        height: 56px;
        border: none;
        border-radius: 12px;
        font-size: 20px;
        cursor: pointer;
        transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.2s ease, color 0.2s ease;
        background: var(--btn-bg);
        color: var(--btn-text);
      }

      button:active {
        transform: translateY(1px);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .btn-operator {
        background: var(--btn-operator);
      }

      .btn-control {
        background: var(--btn-control);
      }

      .btn-clear {
        background: var(--btn-clear);
        color: var(--btn-clear-text);
      }

      .btn-equals {
        background: var(--btn-equals);
        grid-column: span 2;
      }

      .log {
        width: 260px;
        background: var(--card-bg);
        color: var(--text);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 16px;
        border: 1px solid var(--display-border);
        transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
      }

      .log-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin: 0 0 8px 0;
      }

      .log-title {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
      }

      .log-clear {
        border: none;
        background: var(--btn-control);
        color: var(--text);
        border-radius: 8px;
        padding: 6px 10px;
        font-size: 13px;
        cursor: pointer;
        transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.2s ease;
      }

      .log-clear:active {
        transform: translateY(1px);
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
      }

      .log-list {
        list-style: none;
        margin: 0;
        padding: 0;
        max-height: 140px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .log-item {
        font-size: 14px;
        background: var(--display-bg);
        border: 1px solid var(--display-border);
        border-radius: 8px;
        padding: 8px 10px;
        display: flex;
        justify-content: space-between;
        gap: 8px;
      }

      .log-expression {
        color: var(--text);
      }

      .log-result {
        font-weight: 700;
        color: var(--text);
        white-space: nowrap;
      }

      .log-error {
        color: var(--btn-clear);
      }

      @media (max-width: 720px) {
        .layout {
          flex-direction: column;
          align-items: center;
        }

        .log {
          width: 100%;
          max-width: 320px;
        }
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <div class="log" aria-live="polite">
        <div class="log-header">
          <p class="log-title">Журнал операций</p>
          <button id="clearHistory" class="log-clear" type="button">Очистить</button>
        </div>
        <ul id="history" class="log-list"></ul>
      </div>
      <div class="calculator">
        <div class="calculator-header">
          <button id="themeToggle" class="theme-toggle" type="button">
            Темная тема
          </button>
        </div>
        <div id="display" class="display">0</div>
        <div class="grid">
          <button class="btn-control btn-clear" data-action="clear">C</button>
          <button class="btn-control" data-action="backspace">⌫</button>
          <button class="btn-control" data-action="sign">±</button>
          <button class="btn-operator" data-value="/">÷</button>

          <button data-value="7">7</button>
          <button data-value="8">8</button>
          <button data-value="9">9</button>
          <button class="btn-operator" data-value="*">×</button>

          <button data-value="4">4</button>
          <button data-value="5">5</button>
          <button data-value="6">6</button>
          <button class="btn-operator" data-value="-">−</button>

          <button data-value="1">1</button>
          <button data-value="2">2</button>
          <button data-value="3">3</button>
          <button class="btn-operator" data-value="+">+</button>

          <button class="btn-zero" data-value="0">0</button>
          <button data-value=".">.</button>
          <button class="btn-equals" data-action="equals">=</button>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const display = document.getElementById("display");
        const grid = document.querySelector(".grid");
        const themeToggle = document.getElementById("themeToggle");
        const historyList = document.getElementById("history");
        const clearHistoryBtn = document.getElementById("clearHistory");
        const THEME_KEY = "calculator-theme";
        const MAX_HISTORY = 10;
        let expression = "";

        function updateDisplay(value) {
          display.textContent = value || "0";
        }

        function applyTheme(theme) {
          const isDark = theme === "dark";
          document.body.classList.toggle("dark", isDark);
          themeToggle.textContent = isDark ? "Светлая тема" : "Темная тема";
          try {
            localStorage.setItem(THEME_KEY, isDark ? "dark" : "light");
          } catch (_err) {
            /* localStorage может быть недоступен */
          }
        }

        function initTheme() {
          let saved = "light";
          try {
            saved = localStorage.getItem(THEME_KEY) || "light";
          } catch (_err) {
            saved = "light";
          }
          applyTheme(saved === "dark" ? "dark" : "light");
        }

        function appendValue(value) {
          // Запрещаем ввод двух операторов подряд
          if (/[+\-*/]$/.test(expression) && /[+\-*/]/.test(value)) {
            expression = expression.slice(0, -1) + value;
          } else {
            expression += value;
          }
          updateDisplay(expression);
        }

        function compute() {
          if (!expression) {
            return;
          }
          const original = expression;
          try {
            const sanitized = expression.replace(/[^0-9+\-*/.]/g, "");
            const result = Function(`"use strict"; return (${sanitized})`)();
            expression = Number.isFinite(result) ? result.toString() : "";
            updateDisplay(expression || "Ошибка");
            appendToHistory(original, expression || "Ошибка", !expression);
          } catch (err) {
            expression = "";
            updateDisplay("Ошибка");
            appendToHistory(original, "Ошибка", true);
          }
        }

        function appendToHistory(expr, result, isError = false) {
          const item = document.createElement("li");
          item.className = "log-item";

          const expSpan = document.createElement("span");
          expSpan.className = "log-expression";
          expSpan.textContent = expr || "—";

          const resSpan = document.createElement("span");
          resSpan.className = "log-result";
          resSpan.textContent = isError ? "Ошибка" : result;
          if (isError) {
            resSpan.classList.add("log-error");
          }

          item.appendChild(expSpan);
          item.appendChild(resSpan);
          historyList.prepend(item);

          while (historyList.children.length > MAX_HISTORY) {
            historyList.removeChild(historyList.lastElementChild);
          }
        }

        function clearHistory() {
          historyList.innerHTML = "";
        }

        grid.addEventListener("click", (event) => {
          const target = event.target;
          if (target.tagName !== "BUTTON") {
            return;
          }

          const { value } = target.dataset;
          const action = target.dataset.action;

          if (value) {
            appendValue(value);
            return;
          }

          switch (action) {
            case "clear":
              expression = "";
              updateDisplay("");
              break;
            case "backspace":
              expression = expression.slice(0, -1);
              updateDisplay(expression);
              break;
            case "sign":
              if (!expression) {
                return;
              }
              try {
                const lastNumberMatch = expression.match(/(-?\d+\.?\d*)$/);
                if (!lastNumberMatch) {
                  return;
                }
                const lastNumber = lastNumberMatch[0];
                const toggled =
                  lastNumber.startsWith("-") ?
                    lastNumber.slice(1) :
                    "-" + lastNumber;
                expression =
                  expression.slice(0, -lastNumber.length) + toggled;
                updateDisplay(expression);
              } catch (_err) {
                updateDisplay("Ошибка");
              }
              break;
            case "equals":
              compute();
              break;
            default:
              break;
          }
        });

        document.addEventListener("keydown", (event) => {
          const key = event.key;
          if (/^[0-9.+\-*/]$/.test(key)) {
            appendValue(key);
          } else if (key === "Enter" || key === "=") {
            event.preventDefault();
            compute();
          } else if (key === "Backspace") {
            expression = expression.slice(0, -1);
            updateDisplay(expression);
          } else if (key === "Escape") {
            expression = "";
            updateDisplay("");
          }
        });

        themeToggle.addEventListener("click", () => {
          const isDark = document.body.classList.contains("dark");
          applyTheme(isDark ? "light" : "dark");
        });

        clearHistoryBtn.addEventListener("click", clearHistory);

        initTheme();
      })();
    </script>
  </body>
</html>
